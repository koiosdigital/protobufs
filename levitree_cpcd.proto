syntax = "proto3";

package levitree_cpcd;

enum DeviceType {
  DEVICE_ADC = 0;
  DEVICE_DISTANCE_SENSOR = 1;
  DEVICE_VFD = 2;
}

enum PressureSensorRating {
  PSI_50 = 0;
  PSI_100 = 1;
  PSI_150 = 2;
  PSI_200 = 3;
  PSI_250 = 4;
  PSI_300 = 5;
  PSI_350 = 6;
  PSI_400 = 7;
  PSI_450 = 8;
  PSI_500 = 9;
}

enum PressureSensorLocation {
  INLET_PULP = 0;
  INLET_WATER = 1;
  INLET_VISCOSIFIER = 2;
  OUTLET = 3;
}

enum ADCPurpose {
  ADC_GENERIC = 0;
  PRESSURE_SENSOR = 1;
  TEMPERATURE_SENSOR = 2;
  CURRENT_SENSOR = 3;
  VOLTAGE_SENSOR = 4;
}

enum DistanceSensorPurpose {
  DISTANCE_SENSOR_GENERIC = 0;
  TANK_LEVEL = 1;
}

enum VFDLocation {
  VFD_GENERIC = 0;
  VFD_OUTLET = 1;
  VFD_AUGER = 2;
}

enum ADCChannelValueInterpretation {
  VOLTAGE_V = 0;
  CURRENT_A = 1;
  TEMPERATURE_C = 2;
  PRESSURE_PSI = 3;
}

message CPCMessage {
  oneof message {
    Acknowledge acknowledge = 1; //done
    
    GetSystemInfo get_system_info = 2; //done, response is SystemInfoResponse
    SystemInfoResponse system_info_response = 3; //done

    DiscoverAttachedDevices discover_attached_devices = 4; //done, response is DiscoveryPending
    DiscoveryPending discovery_pending = 5; //done, sends DiscoveryComplete when done
    DiscoveryComplete discovery_complete = 6; //done

    GetAttachedDevices get_attached_devices = 7; //done, response is AttachedDevices
    AttachedDevices attached_devices = 8; //done

    //adc
    SetADCSettings set_adc_settings = 9; //done, returns Acknowledge
    ADCStateUpdate adc_state_update = 10; //done

    //distance sensor
    SetDistanceSensorSettings set_distance_sensor_settings = 11; //done, returns Acknowledge
    DistanceSensorStateUpdate distance_sensor_state_update = 12; //done

    //VFD
    SetVFDSettings set_vfd_settings = 13; //done, returns Acknowledge
    VFDStateUpdate vfd_state_update = 14; //done
    SetVFDDirection set_vfd_direction = 15; //done, returns Acknowledge
    SetVFDFrequency set_vfd_frequency = 16; //done, returns Acknowledge

    Heartbeat heartbeat = 17; //done
  }
}

message Acknowledge {

}

message GetSystemInfo {
  
}

message DiscoverAttachedDevices {

}

message GetAttachedDevices {

}

message DiscoveryPending {

}

message DiscoveryComplete {
  int32 device_count = 1;
}

message SystemInfoResponse {
  int32 message_id = 1;
  string firmware_version = 2;
  string hardware_version = 3;
  string serial_number = 4;
}

message ADCChannelSettings {
  bool enabled = 1;
  int32 channel_number = 2;
  ADCPurpose purpose = 3;
  optional PressureSensorRating pressure_sensor_rating = 4;
  optional PressureSensorLocation pressure_sensor_location = 5;
}

message ADCSettings {
  string name = 1;
  int32 channels_mask = 2;
  int32 sample_rate = 3;
  repeated ADCChannelSettings channel_settings = 4;
}

message ADC {
  bytes ecu_id = 1;
  ADCSettings settings = 2;
}

message ADCChannelValue {
  int32 channel_number = 1;
  float value = 2;
  ADCChannelValueInterpretation interpretation = 3;
}

message ADCStateUpdate {
  bytes ecu_id = 1;
  int32 sample_rate = 2;
  repeated ADCChannelValue values = 3;
}

message SetADCSettings {
  bytes ecu_id = 1;
  ADCSettings settings = 2;
}

message DistanceSensor {
  bytes ecu_id = 1;
  DistanceSensorSettings settings = 2;
}

message DistanceSensorSettings {
  string name = 1;
  int32 sample_rate = 2;
  DistanceSensorPurpose purpose = 3;
}

message DistanceSensorStateUpdate {
  bytes ecu_id = 1;
  int32 sample_rate = 2;
  float distance_cm = 3;
}

message SetDistanceSensorSettings {
  bytes ecu_id = 1;
  DistanceSensorSettings settings = 2;
}

message SetVFDSettings {
  bytes ecu_id = 1;
  VFDSettings settings = 2;
}

message VFDCalibration {
  float frequency_hz = 1; //at what frequency
  float volume_gal = 2; //did how many gallons pass
  float time_seconds = 3; //in how many seconds
}

message VFDSettings {
  string name = 1;
  VFDLocation location = 2;
  repeated VFDCalibration calibrations = 3;
}

message VFD {
  bytes ecu_id = 1;
  VFDSettings settings = 2;
}

message VFDStateUpdate {
  bytes ecu_id = 1;
  float frequency = 2;
  bool direction = 3;
  bool stopped = 4;
  float m3_per_hour = 5;
  bool is_calibrated = 6;
}

message AttachedDevice {
  DeviceType device_type = 1;
  oneof device {
    ADC adc = 2;
    DistanceSensor distance_sensor = 3;
    VFD vfd = 4;
  }
}

message SetVFDDirection {
  bytes ecu_id = 1;
  bool direction = 2;
}

message SetVFDFrequency {
  bytes ecu_id = 1;
  float frequency = 2;
}

message AttachedDevices {
  repeated AttachedDevice devices = 1;
}

message Heartbeat {
  bytes ecu_id = 1;
}