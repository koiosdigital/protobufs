syntax = "proto3";

import "kd/v1/common.proto";

package kd.v1;

message MatrxMessage {
    oneof message {
        ScheduleRequest schedule_request = 1;
        Schedule schedule = 2;
        ScheduleItemSetPinState schedule_item_set_pin_state = 3;

        AppRenderRequest app_render_request = 4;
        AppRenderResponse app_render_response = 5;
        AppDataChunk app_data_chunk = 11;  // Chunked data transfer

        DeviceConfigRequest device_config_request = 6;
        DeviceConfig device_config = 7;

        CurrentlyDisplayingApp currently_displaying_app = 8; //to server - device reports what is currently displaying
        DeviceInfo device_info = 9; //to server - device info payload - returns CommandResult

        //common
        CommandResult command_result = 100; //from server - generic command response
        UploadCoreDump upload_core_dump = 101; //to server - returns CommandResult

        // Sent from server when a connection is established.
        JoinResponse join_response = 104; //from server

        // Sent to server to claim the device to a user account.
        ClaimDevice claim_device = 105; //to server

        // Sent from server to trigger factory reset
        FactoryResetRequest factory_reset_request = 106; //from server

        // Certificate management
        CertReport cert_report = 107; //to server - device reports current cert
        CertRenewRequired cert_renew_required = 108; //from server - server requests renewal
        CertRenewRequest cert_renew_request = 109; //to server - device sends CSR
        CertRenewResponse cert_renew_response = 110; //from server - server sends new cert
    }
}

message DeviceInfo {
    uint32 width = 1;
    uint32 height = 2;
    bool has_light_sensor = 3;
}

//MARK: Device Config
message DeviceConfigRequest {

}

message DeviceConfig {
    bool screen_enabled = 1;
    uint32 screen_brightness = 2;
    bool auto_brightness_enabled = 3;
    uint32 screen_off_lux = 4;
}

message ScheduleRequest {

}

message ScheduleItem {
    bytes uuid = 1;
    uint32 display_time = 2;
    bool pinned = 3;
    bool skipped = 4;
}

message Schedule {
    repeated ScheduleItem schedule_items = 1;
}

//MARK: Render
message AppRenderRequest {
    bytes app_uuid = 1;
    bytes data_sha256 = 2;
    uint32 preferred_chunk_size = 3;  // Device's preferred chunk size (e.g., 8192)
}

message AppRenderResponse {
    bytes app_uuid = 1;
    bytes data_sha256 = 2;
    bool  displayable = 3;
    uint32 total_size = 4;      // Total bytes to expect
    uint32 total_chunks = 5;    // Number of AppDataChunk messages to follow
}

message AppDataChunk {
    bytes app_uuid = 1;
    uint32 chunk_index = 2;     // 0-based index
    bytes data = 3;
}

message ScheduleItemSetPinState {
    bytes uuid = 1;
    bool pinned = 2;
}

message CurrentlyDisplayingApp {
    bytes uuid = 1; // UUID of the installation currently being displayed
}