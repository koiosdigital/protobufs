syntax = "proto3";

package kd.v1;

import "kd/v1/enums.proto";

message CommandResult {
    bool success = 1;
    int32 error_code = 2;
    string detail = 3; // Optional human-readable detail
}

message JoinResponse {
    bool success = 1;
    bool is_claimed = 2;

    // When true, the server indicates this device must be claimed before it
    // can operate normally. Older servers may only populate is_claimed.
    bool needs_claimed = 3;
}

// Sent by the device to claim itself to the user's account.
// The claim token is provisioned to the device out-of-band (e.g. over BLE
// console during mobile provisioning) and stored in NVS.
message ClaimDevice {
    bytes claim_token = 1;
}

message CreateOrCheckUserClaim {
    // Empty, server generates OAuth2 device code flow
    string device_code = 1;
}

message UserClaimStatus {
    UserClaimStatusCode status = 1;
    string device_code = 2;
    string access_token = 3;
    string refresh_token = 4;
}

message UploadCoreDump {
    bytes core_dump = 1;
    string firmware_project = 2;
    string firmware_version = 3;
    string firmware_variant = 4;
}

// Sent from server to device to trigger a factory reset.
// Device should clear all local state and restart.
message FactoryResetRequest {
    // Optional reason for the reset (for logging purposes)
    string reason = 1;
}

// Sent from device to server to report current certificate.
message CertReport {
    // PEM-encoded current device certificate
    bytes current_cert = 1;
}

// Sent from server to device when certificate renewal is required.
message CertRenewRequired {
    // Optional reason (e.g., "expiring soon", "revoked")
    string reason = 1;
}

// Sent from device to server with CSR for renewal.
message CertRenewRequest {
    // PEM-encoded Certificate Signing Request (CSR)
    bytes csr = 1;
}

// Sent from server to device with the new certificate.
message CertRenewResponse {
    bool success = 1;
    // PEM-encoded device certificate (only set if success=true)
    bytes device_cert = 2;
    // Error message (only set if success=false)
    string error = 3;
}