syntax = "proto3";

import "kd/v1/common.proto";

package kd.v1;

//Comments formatted as follows:
// First section, before &&&, represents the behavior between local clients and our embedded socket SERVER (on esp32 firmware)
// Second section, after &&&, represents the behavior between ourselves and the cloud socket server, the client in this scenario is the esp32 firmware.

message TranquilMessage {
    oneof message {
        // Schedule (cloud sync)
        TranquilScheduleRequest schedule_request = 1; //client sends, responds with TranquilSchedule &&& bidirectional, responds with TranquilSchedule - send on boot to cloud to get latest sched.
        TranquilSchedule schedule = 2; //bidirectional, sent by client to update our schedule, sent by us to notify in response to above &&& bidirectional, sent by server to update our schedule, sent by us to notify in response to above

        // Pattern management
        DownloadedPatternsRequest downloaded_patterns_request = 3; //bidirectional, responds with DownloadedPatterns &&& bidirectional, responds with DownloadedPatterns
        DownloadedPatterns downloaded_patterns = 4; //response to above &&& response to above
        ModifyPattern modify_pattern = 5; //from local client, can rename, responds with CommandResult &&& from server, renames our local pattern, responds w/ commandresult
        RequestPatternDownload request_pattern_download = 6; //from local client, we forward to server &&& from server, we forward it back, to get a PatternDownloadResponse.
        PatternDownloadResponse pattern_download_response = 7; //N/A - not used &&& from server, tells us how to start the pattern download job
        DeletePattern delete_pattern = 40; //from local client, delete pattern, commandresult &&& same
        GetPatternRequest get_pattern_request = 41; //from local client, patterninfo response &&& same
        PatternInfo pattern_info = 42; //response to above &&& response to above

        // Pattern download progress (websocket broadcast)
        PatternDownloadProgressReport pattern_download_progress = 56; //broadcast to local clients when downloads active, every 5% per job &&& sent to cloud to report download progress

        // Playlist management
        PlaylistsRequest playlists_request = 8; //from local client, playlists response &&& bidirectional, responds with Playlists, we can use this to sync our playlists with server.
        Playlists playlists = 9; //response to above &&& response to above
        CreatePlaylist create_playlist = 43; //from local client, creates playlist, responds with CommandResult &&& from server, creates playlist locally, responds with CommandResult
        UpdatePlaylist update_playlist = 44; //from local client, updates playlist, responds with CommandResult &&& from server, updates playlist locally, responds with CommandResult
        DeletePlaylist delete_playlist = 45; //from local client, deletes playlist, responds with CommandResult &&& from server, deletes playlist locally, responds with CommandResult

        // LED configuration
        LEDConfigRequest led_config_request = 10; //from local client, responds with LEDConfig &&& from server, responds with LEDConfig
        LEDConfig led_config = 11; //response to above &&& response to above
        SetLEDChannel set_led_channel = 46; //from local client, sets LED channel params, responds with CommandResult &&& from server, sets LED channel params, responds with CommandResult
        GetLEDEffects get_led_effects = 47; //from local client, responds with LEDEffectsList &&& from server, responds with LEDEffectsList
        LEDEffectsList led_effects_list = 48; //response to above &&& response to above.

        // Player control
        PlayPattern play_pattern = 12; //from local client, plays pattern, responds with CommandResult &&& from server, plays pattern, responds with CommandResult
        SetPaused set_paused = 13; //from local client, pauses/resumes playback, responds with CommandResult &&& from server, pauses/resumes playback, responds with CommandResult
        PlaylistPlay playlist_play = 14; //from local client, starts playlist playback, responds with CommandResult &&& from server, starts playlist playback, responds with CommandResult
        PlaylistSetShuffle set_shuffle = 15; //from local client, sets shuffle mode, responds with CommandResult &&& from server, sets shuffle mode, responds with CommandResult
        PlaylistNavigateCommand playlist_navigate_command = 16; //from local client, next/prev in playlist, responds with CommandResult &&& from server, next/prev in playlist, responds with CommandResult
        StopPlayback stop_playback = 49; //from local client, stops playback, responds with CommandResult &&& from server, stops playback, responds with CommandResult
        SetFeedRate set_feed_rate = 50; //from local client, sets feed rate, responds with CommandResult &&& from server, sets feed rate, responds with CommandResult
        SetLoop set_loop = 51; //from local client, sets loop mode, responds with CommandResult &&& from server, sets loop mode, responds with CommandResult
        GetPlayerState get_player_state = 52; //from local client, responds with PlayerState &&& from server, responds with PlayerState
        // Smart reporting: state/mode/track/playlist changes send immediately; progress-only updates use cooldown (local: 1s, cloud: 5-10s)
        PlayerState player_state = 53; //response to above, also broadcast on state change to local clients &&& response to above, also sent on state change to cloud

        // Motion/LED Configuration (NVS-backed)
        GetConfigRequest get_config_request = 20; //from local client, responds with GetConfigResponse &&& N/A - not used
        GetConfigResponse get_config_response = 21; //response to above &&& N/A - not used
        SetConfigRequest set_config_request = 22; //from local client, sets motion/LED config, responds with SetConfigResponse &&& N/A - not used
        SetConfigResponse set_config_response = 23; //response to above &&& N/A - not used

        // Presets
        ListPresetsRequest list_presets_request = 24; //from local client, responds with ListPresetsResponse &&& N/A - not used
        ListPresetsResponse list_presets_response = 25; //response to above &&& N/A - not used
        LoadPresetRequest load_preset_request = 26; //from local client, loads hardware preset, responds with LoadPresetResponse &&& N/A - not used
        LoadPresetResponse load_preset_response = 27; //response to above &&& N/A - not used

        // Calibration
        ClearCalibrationRequest clear_calibration_request = 28; //from local client, clears stored calibration, responds with ClearCalibrationResponse &&& N/A - not used
        ClearCalibrationResponse clear_calibration_response = 29; //response to above &&& N/A - not used

        // Homing
        HomeRequest home_request = 30; //from local client, initiates homing sequence, responds with HomeResponse &&& from server, initiates homing sequence, responds with HomeResponse
        HomeResponse home_response = 31; //response to above &&& response to above

        // System
        GetSystemInfo get_system_info = 54; //from local client, responds with SystemInfo &&& from server, responds with SystemInfo
        SystemInfo system_info = 55; //response to above &&& response to above
        Ping ping = 120; //bidirectional, responds with Pong &&& bidirectional, responds with Pong
        Pong pong = 121; //response to above &&& response to above

        // Common
        CommandResult command_result = 100; //response to commands that modify state &&& response to commands that modify state
        UploadCoreDump upload_core_dump = 101; //N/A - not used &&& sent to server on crash recovery with core dump data
        JoinResponse join_response = 104; //N/A not used &&& sent by server on websocket connect with server info and needs_claimed
        ClaimDevice claim_device = 105; //N/a Not used &&& sent by us to server if we need to claim, token from NVS
        FactoryResetRequest factory_reset_request = 106; //from local client, factory resets device, responds with CommandResult &&& from server, factory resets device, responds with CommandResult

        // Certificate management
        CertReport cert_report = 107; //N/A - not used &&& sent to server on connect with current cert info
        CertRenewRequired cert_renew_required = 108; //N/A - not used &&& from server, indicates cert renewal needed
        CertRenewRequest cert_renew_request = 109; //N/A - not used &&& sent to server with CSR for cert renewal
        CertRenewResponse cert_renew_response = 110; //N/A - not used &&& from server with new certificate

        // DRM/License management
        LicenseRequest license_request = 111; //N/A - not used &&& sent to server on boot to fetch/refresh license
        LicenseResponse license_response = 112; //N/A - not used &&& from server with signed license payload
        GetStoreTokenRequest get_store_token_request = 113; //from local client, responds with StoreTokenResponse &&& N/A - not used
        StoreTokenResponse store_token_response = 114; //response to above &&& N/A - not used
    }
}

// =============================================================================
// Pattern Messages
// =============================================================================

message RequestPatternDownload {
    string pattern_uuid = 1;
}

// Response to RequestPatternDownload - contains URL for HTTP download
message PatternDownloadResponse {
    string pattern_uuid = 3;
    string download_url = 4;    // URL to download pattern data from
    PatternInfo pattern = 6;    // Pattern metadata to add to manifest
}

message DownloadedPatternsRequest {}

message DownloadedPatterns {
    repeated PatternInfo patterns = 1;
}

message PatternInfo {
    string uuid = 1;
    string name = 2;
    string creator = 3;
    bool encrypted = 4;
    uint32 size_bytes = 5;
    bool reversible = 6;
    uint32 start_point = 7;  // 0=center, 1=edge
    string created_at = 8;
    string last_played_at = 9;
}

message ModifyPattern {
    string uuid = 1;
    string name = 2;        // Update name if set
}

message DeletePattern {
    string uuid = 1;
}

message GetPatternRequest {
    string uuid = 1;
}

// Progress for a single pattern download job
message PatternDownloadProgress {
    string uuid = 1;            // Pattern UUID being downloaded
    uint32 progress_pct = 2;    // Download progress 0-100
}

// Broadcast report of all active pattern downloads (sent every 5% change per job)
// Not sent when no downloads are active
message PatternDownloadProgressReport {
    repeated PatternDownloadProgress downloads = 1;
}

// =============================================================================
// Playlist Messages
// =============================================================================

message PlaylistsRequest {}

message Playlists {
    repeated PlaylistInfo playlists = 1;
}

message PlaylistInfo {
    string uuid = 1;
    string name = 2;
    string description = 3;
    repeated string pattern_uuids = 4;
    string featured_pattern = 5;
    string created_at = 6;
    string updated_at = 7;
}

message CreatePlaylist {
    string name = 1;
    string description = 2;
    repeated string pattern_uuids = 3;
}

message UpdatePlaylist {
    string uuid = 1;
    string name = 2;
    string description = 3;
    repeated string pattern_uuids = 4;
    string featured_pattern = 5;
}

message DeletePlaylist {
    string uuid = 1;
}

// =============================================================================
// Player Control Messages
// =============================================================================

message PlayPattern {
    string pattern_uuid = 1;
}

message SetPaused {
    bool paused = 1;
}

message PlaylistPlay {
    string playlist_uuid = 1;
    bool shuffle = 2;
    bool loop = 3;
    string start_pattern_uuid = 4;  // Optional: start from specific pattern
}

message PlaylistSetShuffle {
    bool shuffle = 1;
}

message PlaylistNavigateCommand {
    enum Direction {
        DIRECTION_UNSPECIFIED = 0;
        DIRECTION_NEXT = 1;
        DIRECTION_PREVIOUS = 2;
    }
    Direction direction = 1;
}

message StopPlayback {}

message SetFeedRate {
    float feed_rate_rpm = 1;
}

message SetLoop {
    bool enabled = 1;
}

message GetPlayerState {}

message PlayerState {
    enum PlaybackState {
        PLAYBACK_STATE_UNSPECIFIED = 0;
        PLAYBACK_STATE_STOPPED = 1;
        PLAYBACK_STATE_PLAYING = 2;
        PLAYBACK_STATE_PAUSED = 3;
    }
    enum PlayMode {
        PLAY_MODE_UNSPECIFIED = 0;
        PLAY_MODE_SINGLE = 1;
        PLAY_MODE_PLAYLIST = 2;
        PLAY_MODE_PLAYLIST_LOOP = 3;
        PLAY_MODE_PLAYLIST_SHUFFLE = 4;
    }
    PlaybackState state = 1;
    PlayMode mode = 2;
    string current_pattern_uuid = 3;
    string current_playlist_uuid = 4;
    uint32 progress_percent = 5;
    uint32 pattern_index = 6;
    uint32 playlist_size = 7;
    float feed_rate = 8;
    bool shuffle = 9;
    bool loop = 10;
}

// =============================================================================
// LED Control Messages
// =============================================================================

message LEDConfigRequest {}

message LEDConfig {
    bool has_leds = 1;
    uint32 led_count = 2;
    bool is_rgbw = 3;
    string pixdriver_version = 4;
}

message LEDColor {
    uint32 r = 1;
    uint32 g = 2;
    uint32 b = 3;
    uint32 w = 4;  // Optional for RGBW
}

message SetLEDChannel {
    uint32 channel = 1;
    string effect_id = 2;
    uint32 brightness = 3;
    uint32 speed = 4;
    bool enabled = 5;
    LEDColor color = 6;
}

message GetLEDEffects {}

message LEDEffectInfo {
    string id = 1;
    string name = 2;
}

message LEDEffectsList {
    repeated LEDEffectInfo effects = 1;
}

// =============================================================================
// System Messages
// =============================================================================

message GetSystemInfo {}

message SystemInfo {
    string firmware_version = 1;
    string hardware_model = 2;
    string device_id = 3;
    bool is_homed = 4;
    uint32 free_heap = 5;
    string hostname = 6;
}

message Ping {
    uint64 timestamp = 1;
}

message Pong {
    uint64 timestamp = 1;
}

// =============================================================================
// Scheduling Messages
// =============================================================================
message TranquilScheduleRequest {}

message ScheduleAction {
    enum ScheduleActionType {
        SCHEDULE_ACTION_TYPE_UNSPECIFIED = 0;
        SCHEDULE_ACTION_TYPE_LED_OFF = 1;
        SCHEDULE_ACTION_TYPE_LED_ON = 2;
        SCHEDULE_ACTION_TYPE_PLAY_RANDOM_PATTERN = 3;
        SCHEDULE_ACTION_TYPE_PLAY_PLAYLIST = 4;
        SCHEDULE_ACTION_TYPE_PLAY_PATTERN = 5;
    }
    ScheduleActionType type = 1;
    string uuid = 2; //used only for play_playlist / play_pattern;
}

message TranquilScheduleItem {
    uint32 days_of_week = 1;
    uint32 time_of_day = 2;
    ScheduleAction action = 3;
}

message TranquilSchedule {
    repeated TranquilScheduleItem schedule_items = 1;
}

// =============================================================================
// Motion/LED Configuration Messages
// =============================================================================

// Motion configuration - runtime adjustable parameters
message MotionConfigProto {
    uint32 steps_per_rev = 1;
    uint32 microsteps = 2;
    int32 theta_gear_ratio_x100 = 3;
    int32 pinion_diameter_mm = 4;
    int32 theta_max_rpm = 5;
    int32 rho_max_rpm = 6;
    uint32 theta_current_ma = 7;
    uint32 rho_current_ma = 8;
    uint32 stallguard_threshold = 9;
    float default_accel_mm_s2 = 10;
    float max_accel_mm_s2 = 11;
}

// LED configuration
message LEDConfigProto {
    bool has_leds = 1;
    uint32 led_count = 2;
    bool is_rgbw = 3;
}

// Calibration data from homing
message CalibrationDataProto {
    int32 theta_steps_per_rotation = 1;
    int32 rho_max_steps = 2;
    bool is_valid = 3;
    uint32 timestamp = 4;
}

// Get full configuration
message GetConfigRequest {}

message GetConfigResponse {
    MotionConfigProto motion = 1;
    LEDConfigProto led = 2;
    CalibrationDataProto calibration = 3;
    string active_preset_id = 4;
}

// Set configuration (partial update supported)
message SetConfigRequest {
    MotionConfigProto motion = 1;
    LEDConfigProto led = 2;
}

message SetConfigResponse {
    bool success = 1;
    string error = 2;
}

// =============================================================================
// Preset Messages
// =============================================================================

message PresetInfoProto {
    string id = 1;
    string name = 2;
    string description = 3;
}

message ListPresetsRequest {}

message ListPresetsResponse {
    repeated PresetInfoProto presets = 1;
    string active_preset_id = 2;
}

message LoadPresetRequest {
    string preset_id = 1;
}

message LoadPresetResponse {
    bool success = 1;
    string error = 2;
}

// =============================================================================
// Calibration Control Messages
// =============================================================================

message ClearCalibrationRequest {}

message ClearCalibrationResponse {
    bool success = 1;
}

// =============================================================================
// Homing Messages
// =============================================================================

message HomeRequest {
    bool force_full_calibration = 1;
}

message HomeResponse {
    bool success = 1;
    CalibrationDataProto calibration = 2;
    bool used_cached_calibration = 3;
    string error = 4;
}

// =============================================================================
// DRM/License Messages
// =============================================================================

// License request from device
message LicenseRequest {
    string device_id = 1;              // Certificate CN
    bytes current_license_hash = 2;    // SHA-256 of current license (for freshness)
    int64 device_timestamp = 3;        // UTC timestamp
}

// License response from server
message LicenseResponse {
    bool success = 1;
    LicensePayload license = 2;
    bytes signature = 3;               // Server RSA signature over license
    int64 server_timestamp = 4;
    string error = 5;
}

// License content (signed by server)
message LicensePayload {
    string for_device = 1;             // Must match certificate CN
    uint32 max_patterns = 2;           // Maximum stored patterns
    int64 valid_from = 3;              // Unix timestamp UTC
    int64 valid_to = 4;                // Unix timestamp UTC
    string license_id = 5;             // Unique ID for revocation
    int64 issued_at = 6;
    string store_token = 7;            // JWT token for store authentication (max 384 bytes)
}

// Request to get the current store token
message GetStoreTokenRequest {}

// Response with store token
message StoreTokenResponse {
    bool success = 1;
    string store_token = 2;            // JWT token (empty if no valid license or token)
    string error = 3;                  // Error message if not successful
}