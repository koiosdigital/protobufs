syntax = "proto3";

package ringbahn.v1;

import "common/types.proto";
import "devices/device_common.proto";

// Top-level Routing device command message
message RoutingDeviceCommand {
  oneof command {
    // Common commands
    SystemInfoRequest system_info = 1; // Response: SystemInfoResponse
    PingCommand ping = 2; // Response: CommandResult
    ResetCommand reset = 3; // Response: CommandResult
    
    // Discovery commands
    RoutingAttachedDevicesRequest attached_devices = 10; // Response: RoutingAttachedDevicesResponse
    RoutingIdentifyActiveDeviceRequest identify = 11; // Response: RoutingIdentifyActiveDeviceResponse
    RoutingSetChannelIdentityRequest set_channel = 12; // Response: AcknowledgeResponse
    RoutingGetStateRequest get_state = 13; // Response: RoutingDeviceState
    
    // Internal OTA commands
    InternalOtaBeginRequest ota_begin = 20; // Response: InternalOtaStatus
    InternalOtaWriteRequest ota_write = 21; // Response: InternalOtaStatus
    InternalOtaEndRequest ota_end = 22; // Response: InternalOtaStatus
    InternalOtaAbortRequest ota_abort = 23; // Response: InternalOtaStatus
    InternalOtaSetBootPartitionRequest ota_set_boot = 24; // Response: InternalOtaStatus
    
    // Terraboot CAN bootloader commands
    TerrabootEnterRequest terraboot_enter = 30; // Response: AcknowledgeResponse
    TerrabootConnectRequest terraboot_connect = 31; // Response: TerrabootConnectResponse
    TerrabootSendBlockRequest terraboot_send = 32; // Response: TerrabootSendBlockResponse
    TerrabootEofRequest terraboot_eof = 33; // Response: TerrabootEofResponse
    TerrabootRequestBlockRequest terraboot_request = 34; // Response: TerrabootRequestBlockResponse
    TerrabootCompleteRequest terraboot_complete = 35; // Response: TerrabootCompleteResponse
    TerrabootGetIdRequest terraboot_get_id = 36; // Response: TerrabootGetIdResponse
  }
}

// ===== Routing-Specific Messages =====

// Response: RoutingDeviceState
message RoutingGetStateRequest {}

// State published by the routing bridge.
message RoutingDeviceState {
  uint32 connected_devices = 1; // Number of devices detected on the CAN bus
  GPSState gps_state = 2; // Optional GPS snapshot for mobile hubs
}

// ===== Discovery Commands =====

// Response: RoutingAttachedDevicesResponse
message RoutingAttachedDevicesRequest {}

message RoutingAttachedDevicesResponse {
  repeated DeviceInfo devices = 1;
}

// Response: RoutingIdentifyActiveDeviceResponse
message RoutingIdentifyActiveDeviceRequest {}

message RoutingIdentifyActiveDeviceResponse {
  DeviceInfo device = 1; // Active device routed to the UART session
}

// Response: AcknowledgeResponse
message RoutingSetChannelIdentityRequest {
  int32 channel = 1;
  bool active = 2;
}

// ===== Internal OTA (Routing firmware) =====

// Response: InternalOtaStatus
message InternalOtaBeginRequest {
  uint32 image_size = 1; // Total firmware size in bytes
  uint32 firmware_version = 2; // Monotonic firmware version number
}

// Response: InternalOtaStatus
message InternalOtaWriteRequest {
  bytes data = 1; // Firmware chunk
  uint32 offset = 2; // Byte offset within the image
}

// Response: InternalOtaStatus
message InternalOtaEndRequest {
  bool validate_sha256 = 1;
}

// Response: InternalOtaStatus
message InternalOtaAbortRequest {}

// Response: InternalOtaStatus
message InternalOtaSetBootPartitionRequest {}

message InternalOtaStatus {
  uint32 bytes_written = 1;
  uint32 free_space = 2;
  bytes sha256_hash = 3;
  uint32 next_offset = 4;
}

// ===== Terraboot-compatible CAN bootloader bridge =====

// Response: AcknowledgeResponse
message TerrabootEnterRequest {
  DeviceUUID device_uuid = 1; // Target device to reset into bootloader mode (routing translates to CAN node ID)
}

// Response: TerrabootConnectResponse
message TerrabootConnectRequest {
  DeviceUUID device_uuid = 1; // Target device UUID (routing translates to CAN node ID)
}

message TerrabootConnectResponse {
  uint32 protocol_version = 1;
  uint32 start_address = 2;
  uint32 block_size = 3;
  string mcu_type = 4;
  string software_version = 5;
}

// Response: TerrabootSendBlockResponse
message TerrabootSendBlockRequest {
  DeviceUUID device_uuid = 1; // Target device UUID (routing translates to CAN node ID)
  uint32 block_address = 2;
  bytes data = 3;
}

message TerrabootSendBlockResponse {
  uint32 block_address = 1;
}

// Response: TerrabootEofResponse
message TerrabootEofRequest {
  DeviceUUID device_uuid = 1; // Target device UUID (routing translates to CAN node ID)
}

message TerrabootEofResponse {
  uint32 page_count = 1;
}

// Response: TerrabootRequestBlockResponse
message TerrabootRequestBlockRequest {
  DeviceUUID device_uuid = 1; // Target device UUID (routing translates to CAN node ID)
  uint32 block_address = 2;
}

message TerrabootRequestBlockResponse {
  uint32 block_address = 1;
  bytes data = 2;
}

// Response: TerrabootCompleteResponse
message TerrabootCompleteRequest {
  DeviceUUID device_uuid = 1; // Target device UUID (routing translates to CAN node ID)
}

message TerrabootCompleteResponse {
  // Empty - success indicated by no error
}

// Response: TerrabootGetIdResponse
message TerrabootGetIdRequest {
  DeviceUUID device_uuid = 1; // Target device UUID (routing translates to CAN node ID)
}

message TerrabootGetIdResponse {
  bytes can_uuid = 1; // 6 byte CAN UUID (padded by terraboot)
}
