syntax = "proto3";

package ringbahn.v1;

import "common/types.proto";

// State published by the routing bridge.
message RoutingDeviceState {
  uint32 connected_devices = 1; // Number of devices detected on the CAN bus
  GPSState gps_state = 2; // Optional GPS snapshot for mobile hubs
}

// ===== Discovery Commands =====

message RoutingAttachedDevicesRequest {}

message RoutingAttachedDevicesResponse {
  CommandResult result = 1;
  repeated DeviceInfo devices = 2;
}

message RoutingIdentifyActiveDeviceRequest {}

message RoutingIdentifyActiveDeviceResponse {
  CommandResult result = 1;
  DeviceInfo device = 2; // Active device routed to the UART session
}

message RoutingSetChannelIdentityRequest {
  int32 channel = 1;
  bool active = 2;
}

message RoutingSetChannelIdentityResponse {
  CommandResult result = 1;
}

// ===== Internal OTA (Routing firmware) =====

message InternalOtaBeginRequest {
  uint32 image_size = 1; // Total firmware size in bytes
  uint32 firmware_version = 2; // Monotonic firmware version number
}

message InternalOtaWriteRequest {
  bytes data = 1; // Firmware chunk
  uint32 offset = 2; // Byte offset within the image
}

message InternalOtaEndRequest {
  bool validate_sha256 = 1;
}

message InternalOtaAbortRequest {}

message InternalOtaSetBootPartitionRequest {}

message InternalOtaStatus {
  CommandResult result = 1;
  uint32 bytes_written = 2;
  uint32 free_space = 3;
  bytes sha256_hash = 4;
  uint32 next_offset = 5;
}

// ===== Terraboot-compatible CAN bootloader bridge =====

message TerrabootConnectRequest {
  uint32 can_node_id = 1; // Destination CAN node ID
}

message TerrabootConnectResponse {
  CommandResult result = 1;
  uint32 protocol_version = 2;
  uint32 start_address = 3;
  uint32 block_size = 4;
  string mcu_type = 5;
  string software_version = 6;
}

message TerrabootSendBlockRequest {
  uint32 can_node_id = 1;
  uint32 block_address = 2;
  bytes data = 3;
}

message TerrabootSendBlockResponse {
  CommandResult result = 1;
  uint32 block_address = 2;
}

message TerrabootEofRequest {
  uint32 can_node_id = 1;
}

message TerrabootEofResponse {
  CommandResult result = 1;
  uint32 page_count = 2;
}

message TerrabootRequestBlockRequest {
  uint32 can_node_id = 1;
  uint32 block_address = 2;
}

message TerrabootRequestBlockResponse {
  CommandResult result = 1;
  uint32 block_address = 2;
  bytes data = 3;
}

message TerrabootCompleteRequest {
  uint32 can_node_id = 1;
}

message TerrabootCompleteResponse {
  CommandResult result = 1;
}

message TerrabootGetIdRequest {
  uint32 can_node_id = 1;
}

message TerrabootGetIdResponse {
  CommandResult result = 1;
  bytes can_uuid = 2; // 6 byte CAN UUID (padded by terraboot)
}
